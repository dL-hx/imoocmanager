# 13.3 ç”¨æˆ·æˆæƒ

[TOC]



> ä¸ºè§’è‰²åˆ†é…ç”¨æˆ·

[Githubåœ°å€](https://github.com/lenvo222/imoocmanager/commit/d547df5b430ac244e8415a03bf2c5c988519b79d)

## Transfer ç©¿æ¢­æ¡†

> åŒæ ç©¿æ¢­é€‰æ‹©æ¡†

- import { Transfer } from 'antd';
- ` <Transfer />`

## ä½•æ—¶ä½¿ç”¨

- éœ€è¦åœ¨å¤šä¸ªå¯é€‰é¡¹ä¸­è¿›è¡Œå¤šé€‰æ—¶ã€‚
- æ¯”èµ· Select å’Œ TreeSelectï¼Œç©¿æ¢­æ¡†å æ®æ›´å¤§çš„ç©ºé—´ï¼Œå¯ä»¥å±•ç¤ºå¯é€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚

ç©¿æ¢­é€‰æ‹©æ¡†ç”¨ç›´è§‚çš„æ–¹å¼åœ¨ä¸¤æ ä¸­ç§»åŠ¨å…ƒç´ ï¼Œå®Œæˆé€‰æ‹©è¡Œä¸ºã€‚

é€‰æ‹©ä¸€ä¸ªæˆ–ä»¥ä¸Šçš„é€‰é¡¹åï¼Œç‚¹å‡»å¯¹åº”çš„æ–¹å‘é”®ï¼Œå¯ä»¥æŠŠé€‰ä¸­çš„é€‰é¡¹ç§»åŠ¨åˆ°å¦ä¸€æ ã€‚ å…¶ä¸­ï¼Œå·¦è¾¹ä¸€æ ä¸º `source`ï¼Œå³è¾¹ä¸€æ ä¸º `target`ï¼ŒAPI çš„è®¾è®¡ä¹Ÿåæ˜ äº†è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚

![](http://ww1.sinaimg.cn/large/006pJUwqly1g0czc15cbhj30xi0gnaap.jpg)



``` javascript
import { Transfer } from 'antd';

class App extends React.Component {
  state = {
    mockData: [],
    targetKeys: [],
  }

  componentDidMount() {
    this.getMock();
  }

  getMock = () => {
    const targetKeys = [];
    const mockData = [];
    for (let i = 0; i < 20; i++) {
      const data = {
        key: i.toString(),
        title: `content${i + 1}`,
        description: `description of content${i + 1}`,
        chosen: Math.random() * 2 > 1,
      };
      if (data.chosen) {
        targetKeys.push(data.key);
      }
      mockData.push(data);
    }
    this.setState({ mockData, targetKeys });
  }

  filterOption = (inputValue, option) => option.description.indexOf(inputValue) > -1

  handleChange = (targetKeys) => {
    this.setState({ targetKeys });
  }

  handleSearch = (dir, value) => {
    console.log('search:', dir, value);
  };

  render() {
    return (
      <Transfer
        dataSource={this.state.mockData}
        showSearch
        filterOption={this.filterOption}
        targetKeys={this.state.targetKeys}
        onChange={this.handleChange}
        onSearch={this.handleSearch}
        render={item => item.title}
      />
    );
  }
}

ReactDOM.render(<App />, mountNode);
```

![](http://ww1.sinaimg.cn/large/006pJUwqly1g0fj14g30qg31h00o87m5.gif)

### 1. å®šä¹‰æ¥å£

ç”¨æˆ·-è§’è‰²æ•°æ®æ¥å£:    /role/user_list

``` json
{
  "code": 0,
  "result|20": [{
    "status|0-1": 0,
    "user_id|+1": 1,
    "user_name": "@cname"
  }]
}
```

ç”¨æˆ·è§’è‰²è®¾ç½®æäº¤:role/user_role_edit  

``` json
{
  "code": 0
}
```

### 2. å®ä¾‹ä»£ç 

> ğŸ˜‚è¿™é‡Œé‡ç‚¹çœ‹ å­ç»„ä»¶ä¸‰çš„ä»£ç  --------------å°†å…¶ä»–ä»£ç æŠ˜å è®©é€»è¾‘æ¸…æ™°

```javascript
// src/pages/permission/index.js
import React from "react";
import { Card, Button, Form, Modal, Input, Select, Tree, Transfer } from "antd";
import ETable from "./../../components/ETable";
import Utils from "./../../utils/utils";
import axios from "./../../axios";
import menuConfig from "./../../config/menuConfig";

const FormItem = Form.Item;
const Option = Select.Option;
const { TreeNode } = Tree;
// æˆ– const TreeNode = Tree.TreeNode

export default class PermissionUser extends React.Component {
  state = {
    isRoleVisible: false
  };

  componentWillMount() {
    // é€šè¿‡ç”Ÿå‘½å‘¨æœŸå‡½æ•°åŠ è½½æ¥å£
    axios.requestList(this, "/role/list", {}, true);
  }

  requestList = () => {
    axios.requestList(this, "/role/list", {}, true);
  };

  // æ‰“å¼€åˆ›å»ºè§’è‰²å¼¹æ¡†
  handleRole = () => {
    this.setState({
      isRoleVisible: true
    });
  };

  // è§’è‰²æäº¤
  handleRoleSubmit = () => {
    const data = this.roleForm.props.form.getFieldsValue();
    console.log(data);
    axios
      .ajax({
        url: "/role/create", // //Easy Mockä¸­åªæœ‰ï½›"code": 0ï½
        data: {
          params: data
        }
      })
      .then(res => {
        if (res.code == 0) {
          this.setState({
            isRoleVisible: false //å…³é—­å¼¹æ¡†
          });
          this.roleForm.props.form.resetFields(); // è°ƒç”¨è¡¨å•é‡ç½®(æ¸…ç©ºè¡¨å•æ•°æ®)
          this.requestList(); //åˆ·æ–°åˆ—è¡¨æ•°æ®
        }
      });
  };

  // æƒé™è®¾ç½®
  handlePermission = () => {
    let item = this.state.selectedItem; //å–å‡ºå½“å‰é€‰ä¸­çš„é¡¹
    if (!item) {
      Modal.info({
        title: "æ¸©é¦¨æç¤º",
        content: "è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²"
      });
      return;
    }
    this.setState({
      isPermVisible: true,
      detailInfo: item,
      menuInfo: item.menus
    });
  };

  handlePermEditSubmit = () => {
    // è·å–è¡¨å•çš„å€¼ ,æ·»åŠ wrappedComponentRefå±æ€§
    let data = this.permForm.props.form.getFieldsValue();
    data.role_id = this.state.selectedItem.id; // å°†è§’è‰²idä¼ å›
    data.munus = this.state.menuInfo; // éœ€è¦å°†menusæ•°æ®  ä¼ åˆ°æ¥å£

    // å°†æ•°æ®ä¼ å…¥æ¥å£
    axios
      .ajax({
        url: "/permission/edit",
        data: {
          params: {
            ...data
          }
        }
      })
      .then(res => {
        if (res) {
          // æäº¤æˆåŠŸ,   1. å…³é—­é¡µé¢, 2. é‡æ–°è¯·æ±‚æ•°æ®
          this.setState({
            isPermVisible: false
          });
          this.requestList(); //åˆ·æ–°åˆ—è¡¨æ•°æ®
        }
      });
  };

  // ç”¨æˆ·æˆæƒ
  handleUserAuth = () => {
    let item = this.state.selectedItem;
    if (!item) {
      Modal.info({
        title: "æ¸©é¦¨æç¤º",
        content: "è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²"
      });
      return;
    }

    this.setState({
      isUserVisible: true,
      detailInfo: item
    });
    // è·å–ç›®æ ‡æ•°æ®
    this.getRoleUserList(item.id);
  };

  // è·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨
  getRoleUserList = id => {
    // id: è§’è‰²id , è·å–è§’è‰²id
    axios
      .ajax({
        url: "/role/user_list",
        data: {
          params: {
            id
          }
        }
      })
      .then(res => {
        if (res) {
          //è¯·æ±‚æˆåŠŸ,ç­›é€‰ç›®æ ‡ç”¨æˆ·
          this.getAuthUserList(res.result);
        }
      });
  };

  // ç­›é€‰ç›®æ ‡ç”¨æˆ·
  getAuthUserList = dataSource => {
    // å°†æ•°æ®(ç›®æ ‡ç”¨æˆ·,å…¨é‡ç”¨æˆ·)è¿›è¡Œè¿‡æ»¤çš„æ–¹æ³•
    const mockData = [];
    const targetKeys = [];
    if (dataSource && dataSource.length > 0) {
      // æœ‰æ•°æ®
      for (let i = 0; i < dataSource.length; i++) {
        const data = {
          key: dataSource[i].user_id,
          title: dataSource[i].user_name,
          status: dataSource[i].status
        };

        if (data.status == 1) {
          // å¦‚æœstatusæ˜¯1 è¯´æ˜æ˜¯ç›®æ ‡ç”¨æˆ·,åŠ åˆ°targetKeysæ•°ç»„
          targetKeys.push(data.key);
        }
        // å¦åˆ™ è¯´æ˜æ˜¯å…¨é‡æ•°æ®, åŠ å…¥å…¨é‡æ•°ç»„åˆ—è¡¨
        mockData.push(data);
      }
      // å°†å…¨é‡æ•°æ®,ç›®æ ‡æ•°æ®å­˜å…¥setState
      this.setState({
        mockData,
        targetKeys
      });
    }
  };

  // ç”¨æˆ·æˆæƒæäº¤
  handleUserSubmit = () => {
    let data = {}
    data.user_ids = this.state.targetKeys;
    data.role = this.state.selectedItem.id;
    axios.ajax({
      url:'/role/user_role_edit',
      data:{
        params:{// ç­‰åŒäº{user_id:data.user_ids,  role_id:data.role_id}
          ...data 
        }
      }
    }).then((res)=>{
      if(res){
        this.setState({
          isUserVisible:false
        })
        this.requestList();
      }
    })
  };

  render() {
    const columns = [
      {
        title: "è§’è‰²ID",
        dataIndex: "id"
      },
      {
        title: "è§’è‰²åç§°",
        dataIndex: "role_name"
      },
      {
        title: "åˆ›å»ºæ—¶é—´",
        dataIndex: "create_time",
        render: Utils.formateDate
      },
      {
        title: "ä½¿ç”¨çŠ¶æ€",
        dataIndex: "status",
        render(status) {
          return status == 1 ? "åœç”¨" : "å¯ç”¨";
        }
      },
      {
        title: "æˆæƒæ—¶é—´",
        dataIndex: "authorize_time",
        render: Utils.formateDate
      },
      {
        title: "æˆæƒäºº",
        dataIndex: "authorize_user_name"
      }
    ];
    return (
      <div>
        <Card>
          <Button type="primary" onClick={this.handleRole}>
            åˆ›å»ºè§’è‰²
          </Button>
          <Button
            type="primary"
            style={{ marginLeft: 10, marginRight: 10 }}
            onClick={this.handlePermission}
          >
            è®¾ç½®æƒé™
          </Button>
          <Button type="primary" onClick={this.handleUserAuth}>
            ç”¨æˆ·æˆæƒ
          </Button>
        </Card>
        <div className="content-wrap">
          <ETable
            dataSource={this.state.list}
            columns={columns}
            updateSelectedItem={Utils.updateSelectedItem.bind(this)}
            selectedRowKeys={this.state.selectedRowKeys}
            selectedItem={this.state.selectedItem}
          />
        </div>
        <Modal
          title="åˆ›å»ºè§’è‰²"
          visible={this.state.isRoleVisible}
          onOk={this.handleRoleSubmit}
          onCancel={() => {
            this.roleForm.props.form.resetFields(); // è¡¨å•é‡ç½®
            this.setState({
              isRoleVisible: false
            });
          }}
        >
          <RoleForm
            wrappedComponentRef={inst => {
              this.roleForm = inst;
            }}
          />
        </Modal>
        <Modal
          title="è®¾ç½®æƒé™"
          visible={this.state.isPermVisible}
          width={600}
          onOk={this.handlePermEditSubmit}
          onCancel={() => {
            this.setState({
              isPermVisible: false
            });
          }}
        >
          <PermEditForm
            wrappedComponentRef={inst => {
              this.permForm = inst;
            }}
            detailInfo={this.state.detailInfo}
            menuInfo={this.state.menuInfo}
            patchMenuInfo={checkedKeys => {
              this.setState({
                menuInfo: checkedKeys
              });
            }}
          />
        </Modal>
        <Modal
          title="ç”¨æˆ·æˆæƒ"
          visible={this.state.isUserVisible}
          width={800}
          onOk={this.handleUserSubmit}
          onCancel={() => {
            this.setState({
              isUserVisible: false
            });
          }}
        >
          <RoleAuthForm
            wrappedComponentRef={inst => {
              this.userAuthForm = inst;
            }}
            detailInfo={this.state.detailInfo}
            targetKeys={this.state.targetKeys}
            mockData={this.state.mockData}
            patchUserInfo={(targetKeys)=>{
              this.setState({ targetKeys });
            }}
          />
        </Modal>
      </div>
    );
  }
}

// å­ç»„ä»¶ä¸€-------è§’è‰²ç»‘å®š
class RoleForm extends React.Component {
  render() {
    const formItemLayout = {
      labelCol: {
        span: 5
      },
      wrapperCol: {
        span: 19
      }
    };
    const { getFieldDecorator } = this.props.form;
    return (
      <Form layout="horizontal">
        <FormItem label="è§’è‰²åç§°" {...formItemLayout}>
          {getFieldDecorator("role_name")(
            <Input type="text" placeholder="è¯·è¾“å…¥è§’è‰²åç§°" />
          )}
        </FormItem>
        <FormItem label="çŠ¶æ€" {...formItemLayout}>
          {getFieldDecorator("state")(
            <Select>
              <Option value={1}>å¼€å¯</Option>
              <Option value={2}>å…³é—­</Option>
            </Select>
          )}
        </FormItem>
      </Form>
    );
  }
}

RoleForm = Form.create({})(RoleForm);

// å­ç»„ä»¶äºŒ---------è®¾ç½®æƒé™
class PermEditForm extends React.Component {
  onCheck = checkedKeys => {
    // å°†å½“å‰é€‰ä¸­çš„é¡¹ä¼ å›çˆ¶ç»„ä»¶  PermEditForm
    this.props.patchMenuInfo(checkedKeys);
  };

  // é€’å½’æ¸²æŸ“æƒé™åˆ—è¡¨
  /**
   *
   * @param data:menuConfig.js å¯¼å…¥çš„æƒé™åˆ—è¡¨
   */
  renderTreeNodes = data => {
    // åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å­èŠ‚ç‚¹,å¦‚æœæœ‰å­èŠ‚ç‚¹childrenç»§ç»­éå†,ç›´åˆ°æ²¡æœ‰å­èŠ‚ç‚¹ä¸ºæ­¢
    return data.map(item => {
      if (item.children) {
        // åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å­èŠ‚ç‚¹
        return (
          <TreeNode title={item.title} key={item.key}>
            {this.renderTreeNodes(item.children)}
          </TreeNode>
        );
      } else {
        return <TreeNode title={item.title} key={item.key} />;
        // ä¹Ÿå¯å†™ä½œ
        // return <TreeNode {...item}/>
      }
    });
  };

  render() {
    const formItemLayout = {
      labelCol: {
        span: 5
      },
      wrapperCol: {
        span: 19
      }
    };
    const { getFieldDecorator } = this.props.form;
    const detail_info = this.props.detailInfo;
    const menu_info = this.props.menuInfo;
    // console.log(detail_info);
    return (
      <Form layout="horizontal">
        <FormItem label="è§’è‰²åç§°" {...formItemLayout}>
          <Input disabled placeholder={detail_info.role_name} />
        </FormItem>
        <FormItem label="çŠ¶æ€" {...formItemLayout}>
          {getFieldDecorator("status", {
            initialValue: detail_info.status + ""
          })(
            <Select>
              <Option value="0">å¯ç”¨</Option>
              <Option value="1">åœç”¨</Option>
            </Select>
          )}
        </FormItem>
        <Tree
          checkable
          defaultExpandAll
          onCheck={checkedKeys => {
            // checkedKeys: å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
            this.onCheck(checkedKeys);
          }}
          checkedKeys={menu_info}
        >
          <TreeNode title="å¹³å°æƒé™" key="platform_all">
            {this.renderTreeNodes(menuConfig)}
          </TreeNode>
        </Tree>
      </Form>
    );
  }
}

PermEditForm = Form.create({})(PermEditForm);

// å­ç»„ä»¶ä¸‰---------ç”¨æˆ·æˆæƒ
class RoleAuthForm extends React.Component {
  filterOption = (inputValue, option) => {
    return option.title.indexOf(inputValue) > -1;
  };

  handleChange = (targetKeys)=>{
    this.props.patchUserInfo(targetKeys);
  };
  render() {
    const formItemLayout = {
      labelCol: {
        span: 5
      },
      wrapperCol: {
        span: 19
      }
    };
    const detail_info = this.props.detailInfo;
    return (
      <Form layout="horizontal">
        <FormItem label="è§’è‰²åç§°" {...formItemLayout}>
          <Input disabled placeholder={detail_info.role_name} />
        </FormItem>

        <FormItem label="é€‰æ‹©ç”¨æˆ·" {...formItemLayout}>
          <Transfer
            listStyle={{ width: 250, height: 400 }}
            dataSource={this.props.mockData}
            titles={["å¾…é€‰ç”¨æˆ·", "å·²é€‰ç”¨æˆ·"]}
            showSearch
            searchPlaceholder="è¾“å…¥ç”¨æˆ·å"
            filterOption={this.filterOption} //è¿‡æ»¤é€‰é¡¹
            targetKeys={this.props.targetKeys} //ç›®æ ‡æ•°æ®æº
            onChange={this.handleChange} //æ§åˆ¶ç›®æ ‡æ•°æ®æº
            render={item => item.title} //æ¸²æŸ“æ•°æ®
          />
        </FormItem>
      </Form>
    );
  }
}
RoleAuthForm = Form.create({})(RoleAuthForm);

```

